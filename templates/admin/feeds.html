{% extends "base.html" %}

{% block title %}Feed Management V2{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Feed Management</h2>
            <p class="text-muted mb-0">Monitor and manage RSS feeds</p>
        </div>
        <button class="btn btn-primary" id="addFeedBtn">
            <i class="bi bi-plus-lg"></i> Add Feed
        </button>
    </div>

    <!-- Toolbar -->
    <div class="d-flex gap-3 mb-4">
        <!-- Search -->
        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Search feeds...">
        </div>

        <!-- Filter Chips -->
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="filterRadio" id="filterAll" value="all" checked>
            <label class="btn btn-outline-primary" for="filterAll">All</label>

            <input type="radio" class="btn-check" name="filterRadio" id="filterActive" value="active">
            <label class="btn btn-outline-success" for="filterActive">Active</label>

            <input type="radio" class="btn-check" name="filterRadio" id="filterInactive" value="inactive">
            <label class="btn btn-outline-secondary" for="filterInactive">Inactive</label>

            <input type="radio" class="btn-check" name="filterRadio" id="filterErrors" value="errors">
            <label class="btn btn-outline-danger" for="filterErrors">Errors</label>
        </div>

        <!-- Sort -->
        <select class="form-select" id="sortSelect" style="max-width: 200px;">
            <option value="name" selected>Sort by Name</option>
            <option value="created">Sort by Created (Newest)</option>
            <option value="volume">Sort by Most Articles</option>
        </select>
    </div>

    <!-- 2-Column Layout: Feed List + Detail Panel -->
    <div class="row g-3">
        <!-- Left Column: Feed List (60%) -->
        <div class="col-lg-7">
            <div id="feedListContainer">
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Detail Panel (40%) -->
        <div class="col-lg-5">
            <div class="sticky-top" style="top: 20px;">
                <div id="feedDetailContainer">
                    <!-- Empty State (shown when no feed selected) -->
                    <div class="detail-empty text-center py-5">
                        <i class="bi bi-rss" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="text-muted mt-3">Select a feed to view details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Add Feed Modal -->
<div class="modal fade" id="addFeedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFeedForm">
                    <div class="mb-3">
                        <label class="form-label">Feed URL *</label>
                        <input type="url" class="form-control" name="url" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Title (optional)</label>
                                <input type="text" class="form-control" name="title">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Fetch Interval (minutes)</label>
                                <input type="number" class="form-control" name="fetch_interval_minutes" value="60" min="5">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Source *</label>
                                <input type="text" class="form-control" name="source_label" required placeholder="Enter source name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category (optional)</label>
                                <select class="form-select" name="category_id" id="categorySelect">
                                    <option value="">Loading categories...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="auto_analyze_enabled" id="autoAnalyzeCheck">
                        <label class="form-check-label" for="autoAnalyzeCheck">
                            Enable Auto-Analysis
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeedBtn">Add Feed</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Feed Modal -->
<div class="modal fade" id="editFeedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFeedForm">
                    <input type="hidden" id="editFeedId" name="feed_id">

                    <div class="mb-3">
                        <label class="form-label">Feed URL *</label>
                        <input type="url" class="form-control" id="editFeedUrl" name="url" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-control" id="editFeedTitle" name="title">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Fetch Interval (minutes)</label>
                                <input type="number" class="form-control" id="editFeedInterval" name="fetch_interval_minutes" min="5">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Source *</label>
                                <input type="text" class="form-control" id="editFeedSource" name="source_label" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editCategorySelect" name="category_id">
                                    <option value="">Loading categories...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editFeedDescription" name="description" rows="2"></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editAutoAnalyze" name="auto_analyze_enabled">
                        <label class="form-check-label" for="editAutoAnalyze">
                            Enable Auto-Analysis
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editIsCritical" name="is_critical">
                        <label class="form-check-label" for="editIsCritical">
                            Mark as Critical Feed (blocks deletion if referenced)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditFeedBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let currentFilter = 'all';
let currentSort = 'name';
let searchTerm = '';

// API Helpers
async function fetchFeeds() {
    const params = new URLSearchParams({
        filter: currentFilter,
        sort: currentSort,
        search: searchTerm
    });

    const response = await fetch(`/htmx/feeds/list?${params}`);
    if (!response.ok) throw new Error('Failed to fetch feeds');
    return await response.text();
}

async function renderFeeds() {
    const container = document.getElementById('feedListContainer');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

    try {
        const html = await fetchFeeds();
        container.innerHTML = html;

        // Reinitialize HTMX for dynamically loaded content
        if (typeof htmx !== 'undefined') {
            htmx.process(container);
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Error loading feeds: ${error.message}</div>`;
    }
}

// Event Handlers
document.addEventListener('DOMContentLoaded', function() {
    // Initial load
    renderFeeds();

    // Search (debounced)
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchTerm = e.target.value;
            renderFeeds();
        }, 300);
    });

    // Filter
    document.querySelectorAll('input[name="filterRadio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentFilter = this.value;
            renderFeeds();
        });
    });

    // Sort
    document.getElementById('sortSelect').addEventListener('change', function() {
        currentSort = this.value;
        renderFeeds();
    });

    // Add Feed Modal
    document.getElementById('addFeedBtn').addEventListener('click', async function() {
        const modal = new bootstrap.Modal(document.getElementById('addFeedModal'));

        // Load categories
        try {
            const categoriesResp = await fetch('/api/categories');
            const categories = await categoriesResp.json();

            // Populate category select
            const categorySelect = document.getElementById('categorySelect');
            categorySelect.innerHTML = '<option value="">No Category</option>';
            categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }

        modal.show();
    });

    // Save Feed
    document.getElementById('saveFeedBtn').addEventListener('click', async function() {
        const form = document.getElementById('addFeedForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/htmx/feeds/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to create feed');

            bootstrap.Modal.getInstance(document.getElementById('addFeedModal')).hide();
            form.reset();
            renderFeeds();
        } catch (error) {
            alert('Error creating feed: ' + error.message);
        }
    });
});

// Delete Feed Function
async function deleteFeed(feedId) {
    if (!confirm('Are you sure you want to delete this feed? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/htmx/feeds/${feedId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete feed');

        // Clear detail panel
        document.getElementById('feedDetailContainer').innerHTML = `
            <div class="detail-empty text-center py-5">
                <i class="bi bi-rss" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="text-muted mt-3">Select a feed to view details</p>
            </div>
        `;

        // Refresh feed list
        renderFeeds();
    } catch (error) {
        alert('Error deleting feed: ' + error.message);
    }
}

// Load Edit Feed Modal
async function loadEditFeedModal(feedId) {
    try {
        // Fetch feed data
        const response = await fetch(`/htmx/feeds/${feedId}/edit-data`);
        if (!response.ok) throw new Error('Failed to load feed data');
        const feed = await response.json();

        // Populate form fields
        document.getElementById('editFeedId').value = feed.id;
        document.getElementById('editFeedUrl').value = feed.url;
        document.getElementById('editFeedTitle').value = feed.title || '';
        document.getElementById('editFeedInterval').value = feed.fetch_interval_minutes;
        document.getElementById('editFeedSource').value = feed.source_label || '';
        document.getElementById('editFeedDescription').value = feed.description || '';
        document.getElementById('editAutoAnalyze').checked = feed.auto_analyze_enabled || false;
        document.getElementById('editIsCritical').checked = feed.is_critical || false;

        // Load categories
        const categoriesResp = await fetch('/api/categories');
        const categories = await categoriesResp.json();

        const categorySelect = document.getElementById('editCategorySelect');
        categorySelect.innerHTML = '<option value="">No Category</option>';
        categories.forEach(category => {
            const selected = category.id === feed.category_id ? 'selected' : '';
            categorySelect.innerHTML += `<option value="${category.id}" ${selected}>${category.name}</option>`;
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editFeedModal'));
        modal.show();
    } catch (error) {
        alert('Error loading feed: ' + error.message);
    }
}

// Save Edit Feed
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('saveEditFeedBtn').addEventListener('click', async function() {
        const form = document.getElementById('editFeedForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const feedId = data.feed_id;

        // Convert checkboxes to boolean (FormData only includes checked boxes as "on")
        data.auto_analyze_enabled = document.getElementById('editAutoAnalyze').checked;
        data.is_critical = document.getElementById('editIsCritical').checked;

        try {
            const response = await fetch(`/htmx/feeds/${feedId}/update`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to update feed');

            bootstrap.Modal.getInstance(document.getElementById('editFeedModal')).hide();

            // Refresh detail panel
            const detailResp = await fetch(`/htmx/feeds/${feedId}/detail`);
            const detailHtml = await detailResp.text();
            document.getElementById('feedDetailContainer').innerHTML = detailHtml;

            // Refresh feed list
            renderFeeds();
        } catch (error) {
            alert('Error updating feed: ' + error.message);
        }
    });
});
</script>
{% endblock %}
