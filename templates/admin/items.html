{% extends "base.html" %}

{% block title %}Articles - News MCP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Articles Stream</h1>
    <div class="btn-group" role="group">
        <button class="btn btn-outline-primary"
                hx-get="/htmx/items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                hx-vals='{"since_hours": "1"}'
                hx-target="#items-list">
            Last Hour
        </button>
        <button class="btn btn-outline-primary"
                hx-get="/htmx/items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                hx-vals='{"since_hours": "24"}'
                hx-target="#items-list">
            Today
        </button>
        <button class="btn btn-outline-primary"
                hx-get="/htmx/items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                hx-vals='{"since_hours": "168"}'
                hx-target="#items-list">
            This Week
        </button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" placeholder="Search articles..." name="search"
               hx-get="/htmx/items-list" hx-trigger="keyup changed delay:500ms" hx-target="#items-list"
               hx-include="[name='category_id'], [name='feed_id'], [name='search']">
    </div>
    <div class="col-md-3">
        <select class="form-select" name="category_id" id="category-selector"
                hx-get="/htmx/items-list" hx-trigger="change" hx-target="#items-list"
                hx-include="[name='search'], [name='feed_id'], [name='category_id']">
            <option value="0">All Categories</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" name="feed_id" id="feed-selector"
                hx-get="/htmx/items-list" hx-trigger="change" hx-target="#items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']">
            <option value="0">All Feeds</option>
        </select>
    </div>
</div>

<!-- Load options on page load -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only load once
        if (!document.getElementById('feed-selector').dataset.loaded) {
            document.getElementById('feed-selector').dataset.loaded = 'true';

            // Load feed options
            htmx.ajax('GET', '/htmx/feeds-options', {
                target: '#feed-selector',
                swap: 'beforeend'
            });
        }

        if (!document.getElementById('category-selector').dataset.loaded) {
            document.getElementById('category-selector').dataset.loaded = 'true';

            // Load category options
            htmx.ajax('GET', '/htmx/categories-options', {
                target: '#category-selector',
                swap: 'beforeend'
            });
        }
    });
</script>

<div id="items-list" hx-get="/htmx/items-list" hx-trigger="load">
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading articles...</span>
        </div>
    </div>
</div>

<!-- Load More Button -->
<div class="text-center mt-4">
    <button class="btn btn-outline-primary" id="load-more-btn"
            hx-get="/htmx/items-list"
            hx-include="[name='search'], [name='category_id'], [name='feed_id']"
            hx-target="#items-list"
            hx-swap="beforeend"
            onclick="this.setAttribute('hx-vals', JSON.stringify({skip: document.querySelectorAll('#items-list .card').length.toString()}))">
        Load More
    </button>
</div>

<script>
function toggleSentimentDetails(element) {
    const sentimentDiv = element.closest('.sentiment-analysis');
    const detailsDiv = sentimentDiv.querySelector('.sentiment-details');
    const toggleText = element.querySelector('small');

    if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
        detailsDiv.style.display = 'block';
        toggleText.textContent = 'Details ⌃';
    } else {
        detailsDiv.style.display = 'none';
        toggleText.textContent = 'Details ⌄';
    }
}
</script>
{% endblock %}