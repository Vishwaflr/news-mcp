{% extends "base.html" %}

{% block title %}Research Run #{{ run.id }} - News MCP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-light">
        <i class="bi bi-file-earmark-text"></i> Research Run #{{ run.id }}
    </h1>
    <a href="/admin/research/runs" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Runs
    </a>
</div>

<!-- Status Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <h6 class="text-muted">Status</h6>
                {% if run.status == 'completed' %}
                <span class="badge bg-success fs-5">{{ run.status.upper() }}</span>
                {% elif run.status == 'running' %}
                <span class="badge bg-primary fs-5">{{ run.status.upper() }}</span>
                {% elif run.status == 'failed' %}
                <span class="badge bg-danger fs-5">{{ run.status.upper() }}</span>
                {% else %}
                <span class="badge bg-secondary fs-5">{{ run.status.upper() }}</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <h6 class="text-muted">Tokens Used</h6>
                <h4 class="text-warning">{{ run.tokens_used or 'N/A' }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <h6 class="text-muted">Total Cost</h6>
                <h4 class="text-info">${{ "%.6f"|format(run.cost_usd) if run.cost_usd else 'N/A' }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <h6 class="text-muted">Duration</h6>
                <h4 class="text-success">{{ run.duration_seconds }}s</h4>
            </div>
        </div>
    </div>
</div>

<!-- Metadata -->
<div class="card border-secondary mb-4">
    <div class="card-header bg-dark border-secondary">
        <h5 class="mb-0 text-light">Metadata</h5>
    </div>
    <div class="card-body bg-dark">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm table-dark">
                    <tr>
                        <th class="text-muted">Template:</th>
                        <td>
                            {% if template %}
                            <a href="/admin/research/templates/{{ template.id }}/edit" class="text-decoration-none">
                                {{ template.name }}
                            </a>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-muted">Trigger Type:</th>
                        <td><span class="badge bg-info">{{ run.trigger_type }}</span></td>
                    </tr>
                    <tr>
                        <th class="text-muted">Triggered By:</th>
                        <td>{{ run.triggered_by or 'Unknown' }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm table-dark">
                    <tr>
                        <th class="text-muted">Created At:</th>
                        <td>{{ run.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Started At:</th>
                        <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') if run.started_at else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Completed At:</th>
                        <td>{{ run.completed_at.strftime('%Y-%m-%d %H:%M:%S') if run.completed_at else 'N/A' }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Cost Breakdown -->
        {% if run.perplexity_cost_usd or run.llm_cost_usd %}
        <div class="mt-3">
            <h6 class="text-light">Cost Breakdown:</h6>
            <ul class="list-unstyled">
                <li><span class="text-muted">Perplexity:</span> ${{ "%.6f"|format(run.perplexity_cost_usd) if run.perplexity_cost_usd else '0.000000' }}</li>
                <li><span class="text-muted">LLM Processing:</span> ${{ "%.6f"|format(run.llm_cost_usd) if run.llm_cost_usd else '0.000000' }}</li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Query -->
{% if run.query_text %}
<div class="card border-secondary mb-4">
    <div class="card-header bg-dark border-secondary">
        <h5 class="mb-0 text-light">Query</h5>
    </div>
    <div class="card-body bg-dark">
        <pre class="bg-secondary p-3 rounded text-light">{{ run.query_text }}</pre>
    </div>
</div>
{% endif %}

<!-- Result Content -->
{% if run.result_content %}
<div class="card border-secondary mb-4">
    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-light">Result</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="copyResult()">
            <i class="bi bi-clipboard"></i> Copy
        </button>
    </div>
    <div class="card-body bg-dark">
        <div id="result-content" class="bg-secondary p-3 rounded">
            <pre class="text-light mb-0">{{ run.result_content }}</pre>
        </div>
    </div>
</div>
{% endif %}

<!-- Citations -->
{% if run.result_metadata and run.result_metadata.get('citations') %}
<div class="card border-secondary mb-4">
    <div class="card-header bg-dark border-secondary">
        <h5 class="mb-0 text-light">
            <i class="bi bi-link-45deg"></i> Citations
            <span class="badge bg-primary ms-2">{{ run.result_metadata.get('citations')|length }}</span>
        </h5>
    </div>
    <div class="card-body bg-dark">
        <ol class="list-group list-group-numbered">
            {% for citation in run.result_metadata.get('citations', []) %}
            <li class="list-group-item bg-secondary text-light border-0 mb-2">
                <a href="{{ citation }}" target="_blank" class="text-info text-decoration-none">
                    {{ citation }}
                    <i class="bi bi-box-arrow-up-right ms-1"></i>
                </a>
            </li>
            {% endfor %}
        </ol>
    </div>
</div>
{% endif %}

<!-- Result Metadata -->
{% if run.result_metadata %}
<div class="card border-secondary mb-4">
    <div class="card-header bg-dark border-secondary">
        <h5 class="mb-0 text-light">Result Metadata</h5>
    </div>
    <div class="card-body bg-dark">
        <pre class="bg-secondary p-3 rounded text-light">{{ run.result_metadata|tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}

<!-- Error Message -->
{% if run.error_message %}
<div class="alert alert-danger">
    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error</h6>
    <pre class="mb-0">{{ run.error_message }}</pre>
</div>
{% endif %}

<script>
function copyResult() {
    const text = document.getElementById('result-content').innerText;
    navigator.clipboard.writeText(text).then(() => {
        alert('Result copied to clipboard!');
    });
}
</script>

{% endblock %}
