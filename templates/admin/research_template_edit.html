{% extends "base.html" %}

{% block title %}{% if mode == 'create' %}Create{% else %}Edit{% endif %} Research Template - News MCP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-light">
        <i class="bi bi-search"></i>
        {% if mode == 'create' %}Create New{% else %}Edit{% endif %} Research Template
    </h1>
    <a href="/admin/research" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<div class="row">
    <!-- Left Panel: Configuration Form -->
    <div class="col-lg-6">
        <div class="card border-secondary">
            <div class="card-header bg-dark border-secondary">
                <h5 class="mb-0 text-light">Template Configuration</h5>
            </div>
            <div class="card-body bg-dark">
                <form id="templateForm" method="POST" action="{% if mode == 'create' %}/api/research/templates{% else %}/api/research/templates/{{ template.id }}{% endif %}">

                    <!-- Basic Info -->
                    <div class="mb-3">
                        <label class="form-label text-light">Name <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" value="{{ template.name if template else '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Description</label>
                        <textarea name="description" class="form-control" rows="2">{{ template.description if template else '' }}</textarea>
                    </div>

                    <!-- Perplexity Function -->
                    <div class="mb-3">
                        <label class="form-label text-light">Perplexity Function <span class="text-danger">*</span></label>
                        <select name="perplexity_function" class="form-select" required>
                            {% for func in available_functions %}
                            <option value="{{ func }}" {% if template and template.perplexity_function == func %}selected{% endif %}>
                                {{ func.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Choose research function type (domain filter, structured output, etc.)
                        </small>
                    </div>

                    <!-- Dynamic Function Parameters (generated from schema) -->
                    <div id="dynamicParametersContainer">
                        <div class="alert alert-info bg-dark border-info text-light">
                            <i class="bi bi-info-circle"></i>
                            Select a function above to configure its parameters
                        </div>
                    </div>

                    <!-- Perplexity Model Selection -->
                    <h6 class="text-light mt-4 mb-3">Perplexity Configuration</h6>

                    <div class="mb-3">
                        <label class="form-label text-light">Perplexity Model <span class="text-danger">*</span></label>
                        <select name="llm_model" class="form-select" required>
                            <option value="sonar" {% if not template or template.llm_model == 'sonar' %}selected{% endif %}>
                                Sonar ($1.00/$1.00) ‚≠ê Default
                            </option>
                            <option value="sonar-pro" {% if template and template.llm_model == 'sonar-pro' %}selected{% endif %}>
                                Sonar Pro ($3.00/$15.00)
                            </option>
                            <option value="sonar-reasoning" {% if template and template.llm_model == 'sonar-reasoning' %}selected{% endif %}>
                                Sonar Reasoning ($1.00/$5.00)
                            </option>
                            <option value="sonar-reasoning-pro" {% if template and template.llm_model == 'sonar-reasoning-pro' %}selected{% endif %}>
                                Sonar Reasoning Pro ($2.00/$8.00)
                            </option>
                            <option value="sonar-deep-research" {% if template and template.llm_model == 'sonar-deep-research' %}selected{% endif %}>
                                Sonar Deep Research ($2.00/$8.00 + $2.00 citations + $5.00/1K queries + $3.00 reasoning)
                            </option>
                        </select>
                        <small class="form-text text-muted">
                            Prices: Input/Output per 1M tokens
                        </small>
                    </div>

                    <!-- Research Prompt -->
                    <h6 class="text-light mt-4 mb-3">Research Prompt</h6>

                    <div class="mb-3">
                        <label class="form-label text-light">Prompt Template</label>
                        <textarea name="llm_prompt" class="form-control" rows="5" placeholder="Enter your research prompt here...">{{ template.llm_prompt if template else '' }}</textarea>
                        <small class="form-text text-muted">
                            This prompt will be sent to Perplexity for research. Later: auto-generated by LLM.
                        </small>
                    </div>

                    <!-- Scheduling -->
                    <h6 class="text-light mt-4 mb-3">Scheduling</h6>

                    <div class="mb-3 form-check form-switch">
                        <input type="checkbox" name="schedule_enabled" class="form-check-input" id="scheduleEnabled" {% if template and template.schedule_enabled %}checked{% endif %}>
                        <label class="form-check-label text-light" for="scheduleEnabled">Enable Scheduling</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Cron Expression</label>
                        <input type="text" name="cron_expression" class="form-control font-monospace" placeholder="0 6 * * *" value="{{ template.cron_expression if template else '' }}">
                        <small class="form-text text-muted">Example: "0 6 * * *" (daily at 6 AM)</small>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        <input type="checkbox" name="is_active" class="form-check-input" id="isActive" {% if not template or template.is_active %}checked{% endif %}>
                        <label class="form-check-label text-light" for="isActive">Active</label>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Template
                        </button>
                        <a href="/admin/research" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Panel: Test Results -->
    <div class="col-lg-6">
        <div class="card border-secondary">
            <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-light">Test Research</h5>
                <button type="button" id="testButton" class="btn btn-sm btn-primary">
                    <i class="bi bi-play-circle"></i> Run Test
                </button>
            </div>
            <div class="card-body bg-dark">
                <div id="testResults" class="alert alert-info bg-dark border-info text-light">
                    <i class="bi bi-info-circle"></i>
                    Click "Run Test" to execute the research with current configuration and see results.
                </div>

                <div id="testOutput" class="d-none">
                    <!-- Test results will be displayed here -->
                    <div class="mb-3">
                        <label class="form-label text-light">Query Used:</label>
                        <div id="testQuery" class="p-2 bg-secondary rounded font-monospace small"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Result Content:</label>
                        <div id="testContent" class="p-3 bg-secondary rounded" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Citations:</label>
                        <div id="testCitations" class="p-2 bg-secondary rounded"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label text-light">Tokens Used:</label>
                            <div id="testTokens" class="p-2 bg-secondary rounded"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-light">Cost (USD):</label>
                            <div id="testCost" class="p-2 bg-secondary rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variable to store current function parameters
let currentFunctionParameters = {};

// Load function schema and generate dynamic form
async function loadFunctionSchema(functionName) {
    if (!functionName) return;

    try {
        const response = await fetch(`/api/research/functions/${functionName}/schema`);
        const schema = await response.json();

        // Generate dynamic form from schema
        const formHTML = generateDynamicForm(schema);
        document.getElementById('dynamicParametersContainer').innerHTML = formHTML;

        // Load existing values if in edit mode
        {% if template and template.function_parameters %}
        loadExistingParameters({{ template.function_parameters|tojson }});
        {% endif %}

    } catch (err) {
        console.error('Failed to load function schema:', err);
        document.getElementById('dynamicParametersContainer').innerHTML = `
            <div class="alert alert-danger bg-dark border-danger text-light">
                <i class="bi bi-exclamation-triangle"></i>
                Failed to load function parameters
            </div>
        `;
    }
}

// Generate dynamic form from schema
function generateDynamicForm(schema) {
    if (!schema.parameters || schema.parameters.length === 0) {
        return `
            <div class="alert alert-info bg-dark border-info text-light">
                <i class="bi bi-info-circle"></i>
                This function has no configurable parameters
            </div>
        `;
    }

    let html = `<h6 class="text-light mb-3"><i class="${schema.icon || 'bi-gear'}"></i> ${schema.display_name} Parameters</h6>`;
    html += `<p class="text-muted small">${schema.description}</p>`;

    schema.parameters.forEach(param => {
        html += generateParameterField(param);
    });

    return html;
}

// Generate individual parameter field based on type
function generateParameterField(param) {
    const required = param.required ? '<span class="text-danger">*</span>' : '';
    const helpText = param.help_text ? `<small class="form-text text-muted">${param.help_text}</small>` : '';

    let fieldHTML = '';

    switch (param.type) {
        case 'array':
            // Use placeholder as default value if provided (newlines work in value, not in placeholder attribute)
            const defaultValue = param.placeholder || '';
            fieldHTML = `
                <div class="mb-3">
                    <label class="form-label text-light">${param.display_name} ${required}</label>
                    <textarea
                        name="param_${param.name}"
                        class="form-control"
                        rows="22"
                        ${param.required ? 'required' : ''}
                    >${defaultValue}</textarea>
                    ${helpText}
                </div>
            `;
            break;

        case 'enum':
            const options = param.options.map(opt => {
                const selected = opt.value === param.default ? 'checked' : '';
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                            name="param_${param.name}"
                            value="${opt.value}"
                            id="${param.name}_${opt.value}"
                            ${selected}
                            ${param.required ? 'required' : ''}>
                        <label class="form-check-label text-light" for="${param.name}_${opt.value}">
                            ${opt.label}
                        </label>
                    </div>
                `;
            }).join('');
            fieldHTML = `
                <div class="mb-3">
                    <label class="form-label text-light">${param.display_name} ${required}</label>
                    ${options}
                    ${helpText}
                </div>
            `;
            break;

        case 'boolean':
            const checked = param.default ? 'checked' : '';
            fieldHTML = `
                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                        name="param_${param.name}"
                        id="param_${param.name}"
                        ${checked}>
                    <label class="form-check-label text-light" for="param_${param.name}">
                        ${param.display_name}
                    </label>
                    ${helpText}
                </div>
            `;
            break;

        case 'number':
            fieldHTML = `
                <div class="mb-3">
                    <label class="form-label text-light">${param.display_name} ${required}</label>
                    <input type="number"
                        name="param_${param.name}"
                        class="form-control"
                        value="${param.default || ''}"
                        ${param.validation && param.validation.min ? `min="${param.validation.min}"` : ''}
                        ${param.validation && param.validation.max ? `max="${param.validation.max}"` : ''}
                        ${param.required ? 'required' : ''}>
                    ${helpText}
                </div>
            `;
            break;

        case 'json':
            fieldHTML = `
                <div class="mb-3">
                    <label class="form-label text-light">${param.display_name} ${required}</label>
                    <textarea
                        name="param_${param.name}"
                        class="form-control font-monospace"
                        rows="8"
                        placeholder="${param.placeholder || ''}"
                        ${param.required ? 'required' : ''}
                    ></textarea>
                    ${helpText}
                </div>
            `;
            break;

        default:
            fieldHTML = `
                <div class="mb-3">
                    <label class="form-label text-light">${param.display_name} ${required}</label>
                    <input type="text"
                        name="param_${param.name}"
                        class="form-control"
                        placeholder="${param.placeholder || ''}"
                        ${param.required ? 'required' : ''}>
                    ${helpText}
                </div>
            `;
    }

    return fieldHTML;
}

// Load existing parameters into dynamic form
function loadExistingParameters(params) {
    Object.keys(params).forEach(key => {
        const value = params[key];
        const field = document.querySelector(`[name="param_${key}"]`);

        if (field) {
            if (field.type === 'checkbox') {
                field.checked = value;
            } else if (field.type === 'radio') {
                const radio = document.querySelector(`[name="param_${key}"][value="${value}"]`);
                if (radio) radio.checked = true;
            } else if (Array.isArray(value)) {
                field.value = value.join('\n');
            } else if (typeof value === 'object') {
                field.value = JSON.stringify(value, null, 2);
            } else {
                field.value = value;
            }
        }
    });
}

// Collect dynamic parameters from form
function collectDynamicParameters() {
    const params = {};
    const fields = document.querySelectorAll('[name^="param_"]');

    fields.forEach(field => {
        const paramName = field.name.replace('param_', '');

        if (field.type === 'checkbox') {
            params[paramName] = field.checked;
        } else if (field.type === 'radio') {
            if (field.checked) {
                params[paramName] = field.value;
            }
        } else if (field.classList.contains('font-monospace')) {
            // JSON field
            try {
                params[paramName] = JSON.parse(field.value || '{}');
            } catch (err) {
                // If JSON parsing fails, treat as string
                params[paramName] = field.value;
            }
        } else if (field.tagName === 'TEXTAREA') {
            // Array field (one item per line)
            const lines = field.value.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length > 0) {
                params[paramName] = lines;
            }
        } else if (field.type === 'number') {
            params[paramName] = parseFloat(field.value);
        } else {
            if (field.value) {
                params[paramName] = field.value;
            }
        }
    });

    return params;
}

// Listen for function dropdown changes
document.querySelector('select[name="perplexity_function"]').addEventListener('change', function(e) {
    loadFunctionSchema(e.target.value);
});

// Load schema on page load if function is already selected
document.addEventListener('DOMContentLoaded', function() {
    const selectedFunction = document.querySelector('select[name="perplexity_function"]').value;
    if (selectedFunction) {
        loadFunctionSchema(selectedFunction);
    }
});

// Handle test button click
document.getElementById('testButton').addEventListener('click', async function() {
    const button = this;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

    // Hide previous results
    document.getElementById('testResults').classList.remove('d-none');
    document.getElementById('testOutput').classList.add('d-none');
    document.getElementById('testResults').className = 'alert alert-info bg-dark border-info text-light';
    document.getElementById('testResults').innerHTML = '<i class="bi bi-hourglass-split"></i> Running research test...';

    // Collect form data
    const formData = new FormData(document.getElementById('templateForm'));
    const data = {
        perplexity_function: formData.get('perplexity_function'),
        function_parameters: collectDynamicParameters(), // Use dynamic parameters
        llm_model: formData.get('llm_model'),
        llm_prompt: formData.get('llm_prompt')
    };

    try {
        const response = await fetch('/api/research/templates/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            // Show success
            document.getElementById('testResults').className = 'alert alert-success bg-dark border-success text-light';
            document.getElementById('testResults').innerHTML = '<i class="bi bi-check-circle"></i> Test completed successfully!';

            // Show results
            document.getElementById('testOutput').classList.remove('d-none');
            document.getElementById('testQuery').textContent = result.query || data.llm_prompt;
            document.getElementById('testContent').innerHTML = result.content || 'No content';

            // Display citations
            const citations = result.citations || [];
            if (citations.length > 0) {
                const citationHTML = citations.map((c, i) =>
                    `<div class="mb-2"><strong>${i+1}.</strong> <a href="${c}" target="_blank" class="text-primary">${c}</a></div>`
                ).join('');
                document.getElementById('testCitations').innerHTML = citationHTML;
            } else {
                document.getElementById('testCitations').innerHTML = '<em class="text-muted">No citations</em>';
            }

            document.getElementById('testTokens').textContent = result.tokens_used || 'N/A';
            document.getElementById('testCost').textContent = result.cost_usd ? `$${result.cost_usd.toFixed(6)}` : 'N/A';
        } else {
            // Show error
            document.getElementById('testResults').className = 'alert alert-danger bg-dark border-danger text-light';
            document.getElementById('testResults').innerHTML = `<i class="bi bi-exclamation-triangle"></i> Test failed: ${result.detail || 'Unknown error'}`;
        }
    } catch (err) {
        document.getElementById('testResults').className = 'alert alert-danger bg-dark border-danger text-light';
        document.getElementById('testResults').innerHTML = `<i class="bi bi-exclamation-triangle"></i> Network error: ${err.message}`;
    } finally {
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
});

// Handle form submission
document.getElementById('templateForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Convert checkboxes to booleans
    data.schedule_enabled = formData.has('schedule_enabled');
    data.is_active = formData.has('is_active');

    // Use dynamic parameters (already collected)
    data.function_parameters = collectDynamicParameters();

    const method = '{{ mode }}' === 'create' ? 'POST' : 'PUT';
    const url = e.target.action;

    try {
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('Template saved successfully!');
            window.location.href = '/admin/research';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to save template'));
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
});
</script>

{% endblock %}
